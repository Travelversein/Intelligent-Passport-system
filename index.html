<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passport Information Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // Theme script is kept for toggling, but defaults to dark now.
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage))) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* --- NEW UI STYLE DEFINITIONS --- */
        :root {
            /* Light theme colors (kept for toggle functionality) */
            --bg-primary: #ffffff;
            --bg-secondary: #f4f4f4;
            --bg-tertiary: #ffffff;
            --text-primary: #000000;
            --text-secondary: #666666;
            --border-color: #e5e5e5;
            --accent-color: #000000;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --btn-primary-bg: #000000;
            --btn-primary-text: #ffffff;
            --btn-secondary-bg: #e5e5e5;
            --btn-secondary-text: #000000;
        }

        .dark {
            /* Dark theme inspired by narrativeco.in */
            --bg-primary: #0a0a0a;
            --bg-secondary: #000000;
            --bg-tertiary: #0a0a0a;
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --border-color: #222222;
            --accent-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --btn-primary-bg: #ffffff;
            --btn-primary-text: #000000;
            --btn-secondary-bg: #1f1f1f;
            --btn-secondary-text: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Main panels with sharp corners */
        .main-panel {
            background-color: var(--bg-tertiary);
            border-radius: 0; /* Sharp corners */
            border: 1px solid var(--border-color);
            box-shadow: none; /* Removed shadow for a flatter look */
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* --- REFINED TYPOGRAPHY HIERARCHY --- */
        .title-main {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 4rem; /* Main title size */
            letter-spacing: 2px;
            text-transform: uppercase;
            line-height: 1;
        }
        .title-section { 
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.75rem; /* Reduced section title size */
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-primary); 
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color); /* Separator line */
        }
        h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 1.5rem;
        }
        p { color: var(--text-secondary); }

        /* Redesigned buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 12px 20px;
            border-radius: 0; /* Sharp corners */
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Outlined primary button style */
        .btn-primary {
            background-color: transparent;
            color: var(--text-primary);
            border-color: var(--text-primary);
        }
        .dark .btn-primary:hover:not(:disabled) { background-color: var(--text-primary); color: var(--bg-primary); }
        .light .btn-primary:hover:not(:disabled) { background-color: var(--text-primary); color: var(--bg-primary); }

        /* Solid secondary button style */
        .btn-secondary { 
            background-color: var(--btn-secondary-bg); 
            color: var(--btn-secondary-text);
            border-color: var(--btn-secondary-bg);
        }
        .btn-secondary:hover:not(:disabled) { filter: brightness(1.2); }
        .dark .btn-secondary:hover:not(:disabled) { filter: brightness(1.2); }

        /* Redesigned form inputs */
        .form-input, .form-select {
            width: 100%;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 10px 14px;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .dark .form-input, .dark .form-select { background-color: #000; }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            background-color: var(--bg-tertiary);
            box-shadow: none;
        }
        
        .form-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Improved styling for date inputs to ensure calendar icon is visible */
        .dark input[type="date"] { color-scheme: dark; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: brightness(0.8);
        }
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(0.8);
        }

        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .active-dashboard-filter { background-color: var(--btn-secondary-bg); }
        
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .toast-in { animation: slideInRight 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .toast-out { animation: slideOutRight 0.5s cubic-bezier(0.5, 0, 0.75, 0) forwards; }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-12">
            <div class="text-left">
                <h1 class="title-main">Travelverse Passport Extractor</h1>
                <p class="max-w-2xl mt-4">Upload a passport image to automatically extract and save traveler information.</p>
            </div>
             <div class="flex items-center gap-2">
                <button id="theme-toggle" type="button" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700/50 focus:outline-none transition-colors">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zm7.536 2.464a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414z"></path></svg>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="main-panel p-6">
                <h2 class="title-section">Upload Passport</h2>
                <div id="upload-container" class="border-2 border-dashed border-[var(--border-color)] p-8 text-center cursor-pointer hover:bg-[var(--bg-secondary)] transition-colors">
                    <input type="file" id="passport-upload" class="hidden" accept=".pdf,.png,.jpeg,.jpg">
                    <svg class="mx-auto h-12 w-12 text-[var(--text-secondary)]" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <p class="mt-2 text-sm"><span class="font-medium text-[var(--accent-color)]">Click to upload</span> or drag and drop</p>
                    <p class="text-xs text-[var(--text-secondary)] mt-1">PNG, JPG, JPEG, or PDF</p>
                </div>
                
                 <div id="loading-spinner" class="mt-6 hidden text-center"><div class="loader mx-auto"></div><p id="loading-text" class="mt-4">Extracting information, please wait...</p></div>

                <div id="comparison-view" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 items-start">
                    <div><img id="image-preview" src="#" alt="Passport Preview" class="w-full border border-[var(--border-color)]"></div>
                    <div>
                        <h3>Extracted Information</h3>
                        <div id="extracted-data" class="space-y-4"></div>
                        <div class="mt-4">
                            <label for="tags-input" class="form-label mb-1 block">Tags (comma-separated)</label>
                            <input type="text" id="tags-input" placeholder="e.g. Family Trip, VIP" class="form-input text-sm">
                        </div>
                        <button id="save-button" class="btn btn-primary mt-6 w-full" disabled>
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3.75H6.912a2.25 2.25 0 00-2.15 1.588L2.35 13.177a2.25 2.25 0 00-.1.661V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338A2.25 2.25 0 0017.088 3.75H15M12 3.75v9" /></svg>
                            <span id="save-button-text">Save Information</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="main-panel p-6">
                <h2 class="title-section">Saved Records</h2>
                <div class="flex items-center space-x-2 md:space-x-4 mb-6 text-center">
                    <div id="dashboard-total" class="flex-1 p-2 cursor-pointer transition-colors"><p class="text-3xl font-bold font-sans" id="total-records">0</p><p class="text-xs uppercase tracking-wider">Total</p></div>
                    <div id="dashboard-expiring-soon" class="flex-1 p-2 cursor-pointer transition-colors"><p class="text-3xl font-bold font-sans text-yellow-500" id="expiring-soon">0</p><p class="text-xs uppercase tracking-wider">Expiring &lt; 1 Yr</p></div>
                    <div id="dashboard-expiring-6m" class="flex-1 p-2 cursor-pointer transition-colors"><p class="text-3xl font-bold font-sans text-red-500" id="expiring-6m">0</p><p class="text-xs uppercase tracking-wider">Expiring &lt; 6 Mo</p></div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div class="relative"><input type="text" id="search-bar" placeholder="Search..." class="form-input pl-10"><svg class="w-5 h-5 text-[var(--text-secondary)] absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg></div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="sort-by" class="form-select"><option value="createdAt">Sort: Date</option><option value="surname">Sort: Name</option><option value="dateOfExpiry">Sort: Expiry</option></select>
                        <select id="filter-expiry" class="form-select">
                            <option value="all">Filter: All</option>
                            <option value="1y">Expiring &lt; 1yr</option>
                            <option value="6m">Expiring &lt; 6mo</option>
                        </select>
                    </div>
                </div>
                 <button id="export-csv" class="btn btn-secondary w-full mb-4"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v4.59L7.3 9.24a.75.75 0 00-1.1 1.02l3.25 3.5a.75.75 0 001.1 0l3.25-3.5a.75.75 0 10-1.1-1.02l-1.95 2.1V6.75z" clip-rule="evenodd" /></svg><span>Export All to CSV</span></button>
                <div id="history-container" class="space-y-4 max-h-[550px] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>
    
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 bg-[var(--bg-tertiary)] border-[var(--border-color)]">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                <h3 class="text-lg leading-6 font-medium mt-2">Delete Record</h3>
                <div class="mt-2 px-7 py-3"><p class="text-sm">Are you sure? This action cannot be undone.</p></div>
                <div class="flex gap-2 items-center px-4 py-3">
                    <button id="cancel-delete-btn" class="btn btn-secondary w-full">Cancel</button>
                    <button id="confirm-delete-btn" class="btn btn-primary w-full bg-red-600 hover:bg-red-700 border-red-600 hover:border-red-700">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <footer class="text-center py-8 text-sm text-[var(--text-secondary)]">
        <p>Intelligent travel system I Powered by Travelverse</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // --- NEW: Import Firebase Storage modules ---
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCtEzszro3KuPP__512HWj_8T16ElZUOAU",
          authDomain: "passport-technology-8ecfa.firebaseapp.com",
          projectId: "passport-technology-8ecfa",
          storageBucket: "passport-technology-8ecfa.appspot.com", // Corrected storage bucket URL
          messagingSenderId: "834455244022",
          appId: "1:834455244022:web:ad7ba60cb7e1e38106b0d7",
          measurementId: "G-2RRTNRFWLF"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // --- NEW: Initialize Firebase Storage ---
        const storage = getStorage(app);

        let userId = null;
        let allPassports = [];
        let dataListenerUnsubscribe = null;
        let recordToDeleteId = null; 

        // --- DOM Elements ---
        const dom = { 
            uploadContainer: document.getElementById('upload-container'),
            passportUpload: document.getElementById('passport-upload'),
            loadingSpinner: document.getElementById('loading-spinner'),
            loadingText: document.getElementById('loading-text'),
            historyContainer: document.getElementById('history-container'),
            searchBar: document.getElementById('search-bar'),
            tagsInput: document.getElementById('tags-input'), 
            exportCsvButton: document.getElementById('export-csv'),
            sortByEl: document.getElementById('sort-by'),
            filterExpiryEl: document.getElementById('filter-expiry'), 
            deleteModal: document.getElementById('delete-modal'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'), 
            themeToggle: document.getElementById('theme-toggle'),
            darkIcon: document.getElementById('theme-toggle-dark-icon'),
            lightIcon: document.getElementById('theme-toggle-light-icon'), 
            comparisonView: document.getElementById('comparison-view'),
            imagePreview: document.getElementById('image-preview'),
            extractedDataEl: document.getElementById('extracted-data'), 
            saveButton: document.getElementById('save-button'),
            dashboard: {
                total: document.getElementById('total-records'),
                expiringSoon: document.getElementById('expiring-soon'),
                expiring6m: document.getElementById('expiring-6m')
            }
        };

        // --- UI & Helper Functions ---
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500',
            };
            toast.className = `toast-in text-white p-4 text-sm ${colors[type] || 'bg-gray-500'}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.replace('toast-in', 'toast-out');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }
        
        function formatDate(date) {
            if (!date) return 'N/A';
            const d = date instanceof Date ? date : date.toDate();
            return d.toLocaleDateString('en-GB'); // DD/MM/YYYY
        }

        function setLoading(isLoading, text = "Processing...") {
            if (isLoading) {
                dom.loadingText.textContent = text;
                dom.uploadContainer.classList.add('hidden');
                dom.comparisonView.classList.add('hidden');
                dom.loadingSpinner.classList.remove('hidden');
            } else {
                dom.loadingSpinner.classList.add('hidden');
            }
        }
        
        function resetUploadUI() {
            setLoading(false);
            dom.uploadContainer.classList.remove('hidden');
            dom.comparisonView.classList.add('hidden');
            dom.passportUpload.value = '';
            dom.imagePreview.src = '#';
            dom.extractedDataEl.innerHTML = '';
            dom.tagsInput.value = '';
            dom.saveButton.disabled = true;
        }

        // --- NEW: Core Upload & Save Logic ---
        async function handleFileUploadAndSave(file) {
            if (!file || !userId) {
                showToast("Cannot process file. Please sign in and select a file.", "error");
                return;
            }

            try {
                // Show local image preview immediately
                const reader = new FileReader();
                reader.onload = (e) => dom.imagePreview.src = e.target.result;
                reader.readAsDataURL(file);

                setLoading(true, "Uploading passport image...");

                // Step 1: Upload the file to Cloud Storage
                const filePath = `passports/${userId}/${Date.now()}-${file.name}`;
                const storageRef = ref(storage, filePath);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                setLoading(true, "Extracting data and saving...");

                // Step 2: (Placeholder) Perform OCR/extraction on the file
                // In a real app, you would call your extraction API (e.g., a Cloud Function).
                // For this example, we'll use placeholder data.
                const extractedData = {
                    givenName: "Jane",
                    surname: "Doe",
                    passportNo: "A12345678",
                    issuingCountryCode: "USA",
                    nationality: "American",
                    sex: "Female",
                    dateOfBirth: "1990-05-15",
                    placeOfBirth: "New York, USA",
                    dateOfIssue: "2020-10-01",
                    dateOfExpiry: "2030-09-30"
                };

                // Step 3: Save the extracted data AND the image URL to Firestore
                const passportRecord = {
                    ...extractedData,
                    imageUrl: downloadURL,      // Store the link from Cloud Storage
                    imagePath: filePath,        // Store the path to enable deletion later
                    tags: ["new-upload"],
                    createdAt: new Date(),
                    userId: userId
                };

                await addDoc(collection(db, 'passports'), passportRecord);
                
                showToast("Passport saved successfully!", "success");
                resetUploadUI();

            } catch (error) {
                console.error("Error during file processing:", error);
                showToast(`Upload failed: ${error.message}`, "error");
                resetUploadUI();
            }
        }
        
        // --- Data Rendering & Filtering ---
        function renderHistory(passports) {
            dom.historyContainer.innerHTML = '';
            if (passports.length === 0) {
                dom.historyContainer.innerHTML = '<p class="text-center text-sm">No records found.</p>';
                return;
            }

            passports.forEach(passport => {
                const expiryDate = passport.dateOfExpiry ? new Date(passport.dateOfExpiry) : null;
                const now = new Date();
                const oneYearFromNow = new Date(); oneYearFromNow.setFullYear(now.getFullYear() + 1);
                const sixMonthsFromNow = new Date(); sixMonthsFromNow.setMonth(now.getMonth() + 6);
                
                let expiryClass = '';
                if (expiryDate && expiryDate < now) expiryClass = 'border-red-500/40';
                else if (expiryDate && expiryDate < sixMonthsFromNow) expiryClass = 'border-red-500/40';
                else if (expiryDate && expiryDate < oneYearFromNow) expiryClass = 'border-yellow-500/40';

                const card = document.createElement('div');
                card.className = `bg-[var(--bg-secondary)] p-4 border-l-4 ${expiryClass} flex items-center gap-4`;
                card.innerHTML = `
                    <img src="${passport.imageUrl}" alt="Passport photo of ${passport.givenName}" class="w-16 h-16 object-cover flex-shrink-0 bg-gray-700">
                    <div class="flex-grow">
                        <p class="font-bold text-lg">${passport.surname}, ${passport.givenName}</p>
                        <p class="text-sm">Passport No: <span class="font-mono">${passport.passportNo}</span></p>
                        <p class="text-sm">Expires: <span class="font-medium">${passport.dateOfExpiry ? formatDate(new Date(passport.dateOfExpiry)) : 'N/A'}</span></p>
                    </div>
                    <button data-id="${passport.id}" class="delete-btn p-2 text-gray-500 hover:text-red-500 transition-colors">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                dom.historyContainer.appendChild(card);
            });
        }
        
        function updateDashboard() {
            const now = new Date();
            const oneYearFromNow = new Date(); oneYearFromNow.setFullYear(now.getFullYear() + 1);
            const sixMonthsFromNow = new Date(); sixMonthsFromNow.setMonth(now.getMonth() + 6);
            
            let expiringSoonCount = 0;
            let expiring6mCount = 0;

            allPassports.forEach(p => {
                if (!p.dateOfExpiry) return;
                const expiryDate = new Date(p.dateOfExpiry);
                if (expiryDate > now && expiryDate < oneYearFromNow) expiringSoonCount++;
                if (expiryDate > now && expiryDate < sixMonthsFromNow) expiring6mCount++;
            });

            dom.dashboard.total.textContent = allPassports.length;
            dom.dashboard.expiringSoon.textContent = expiringSoonCount;
            dom.dashboard.expiring6m.textContent = expiring6mCount;
        }

        function filterAndRenderPassports() {
            const searchTerm = dom.searchBar.value.toLowerCase();
            const sortBy = dom.sortByEl.value;
            const filterExpiry = dom.filterExpiryEl.value;

            let filtered = [...allPassports];

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.givenName.toLowerCase().includes(searchTerm) ||
                    p.surname.toLowerCase().includes(searchTerm) ||
                    p.passportNo.toLowerCase().includes(searchTerm)
                );
            }

            // Filter by expiry
            if (filterExpiry !== 'all') {
                const now = new Date();
                const limitDate = new Date();
                if (filterExpiry === '1y') limitDate.setFullYear(now.getFullYear() + 1);
                if (filterExpiry === '6m') limitDate.setMonth(now.getMonth() + 6);
                
                filtered = filtered.filter(p => {
                    if (!p.dateOfExpiry) return false;
                    const expiryDate = new Date(p.dateOfExpiry);
                    return expiryDate > now && expiryDate < limitDate;
                });
            }

            // Sort
            filtered.sort((a, b) => {
                if (sortBy === 'surname') {
                    return a.surname.localeCompare(b.surname);
                }
                if (sortBy === 'dateOfExpiry') {
                    return new Date(a.dateOfExpiry) - new Date(b.dateOfExpiry);
                }
                // Default sort by createdAt descending
                return b.createdAt.toDate() - a.createdAt.toDate();
            });
            
            renderHistory(filtered);
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            // File Upload
            dom.uploadContainer.addEventListener('click', () => dom.passportUpload.click());
            dom.passportUpload.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUploadAndSave(e.target.files[0]);
                }
            });

            // Filtering and Sorting
            [dom.searchBar, dom.sortByEl, dom.filterExpiryEl].forEach(el => {
                el.addEventListener('input', filterAndRenderPassports);
            });

            // Delete Logic
            dom.historyContainer.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-btn');
                if (deleteButton) {
                    recordToDeleteId = deleteButton.dataset.id;
                    dom.deleteModal.classList.remove('hidden');
                }
            });
            dom.cancelDeleteBtn.addEventListener('click', () => {
                recordToDeleteId = null;
                dom.deleteModal.classList.add('hidden');
            });
            dom.confirmDeleteBtn.addEventListener('click', async () => {
                if (recordToDeleteId) {
                    try {
                        await deleteDoc(doc(db, 'passports', recordToDeleteId));
                        showToast('Record deleted.', 'success');
                    } catch (error) {
                        showToast('Error deleting record.', 'error');
                        console.error("Deletion error:", error);
                    } finally {
                        recordToDeleteId = null;
                        dom.deleteModal.classList.add('hidden');
                    }
                }
            });

            // Theme Toggle
            dom.themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateThemeIcons();
            });
        }
        
        function updateThemeIcons() {
             if (document.documentElement.classList.contains('dark')) {
                dom.darkIcon.classList.remove('hidden');
                dom.lightIcon.classList.add('hidden');
            } else {
                dom.darkIcon.classList.add('hidden');
                dom.lightIcon.classList.remove('hidden');
            }
        }

        // --- App Initialization ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                if (dataListenerUnsubscribe) dataListenerUnsubscribe(); // Detach old listener

                const q = query(collection(db, 'passports'), where("userId", "==", userId));
                dataListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                    allPassports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    filterAndRenderPassports();
                    updateDashboard();
                }, (error) => {
                    console.error("Error fetching data:", error);
                    showToast("Could not fetch records.", "error");
                });
            } else {
                signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
            }
        });
        
        updateThemeIcons();
        setupEventListeners();

    </script>

</body>
</html>
